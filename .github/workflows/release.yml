name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Get tag info
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Release: $TAG_NAME"
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate PDFs
        run: |
          python scripts/generate_pdf.py
          ls -lh output/*/*pdf | wc -l
      
      - name: Create PDF artifacts (all languages + individual language zips)
        run: |
          cd output
          
          # Create complete zip with all languages
          zip -r ../binder-pokedex-all-languages.zip . -x ".*" "*/.*"
          
          # Create individual zips per language
          for lang in de en fr es it ja ko zh_hans zh_hant; do
            if [ -d "$lang" ]; then
              zip -r ../binder-pokedex-${lang}.zip $lang -x ".*"
            fi
          done
          
          cd ..
          ls -lh binder-pokedex*.zip
      
      - name: Create Release with Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Binder Pok√©dex ${{ steps.tag.outputs.tag_name }}
          files: |
            binder-pokedex-all-languages.zip
            binder-pokedex-de.zip
            binder-pokedex-en.zip
            binder-pokedex-fr.zip
            binder-pokedex-es.zip
            binder-pokedex-it.zip
            binder-pokedex-ja.zip
            binder-pokedex-ko.zip
            binder-pokedex-zh_hans.zip
            binder-pokedex-zh_hant.zip
          body: |
            ## üöÄ Binder Pok√©dex ${{ steps.tag.outputs.tag_name }} Released!
            
            ### üì¶ Downloads
            - **binder-pokedex-all-languages.zip** - Complete set with all 9 languages (117 PDFs)
            - **binder-pokedex-de.zip** - Deutsch
            - **binder-pokedex-en.zip** - English
            - **binder-pokedex-fr.zip** - Fran√ßais
            - **binder-pokedex-es.zip** - Espa√±ol
            - **binder-pokedex-it.zip** - Italiano
            - **binder-pokedex-ja.zip** - Êó•Êú¨Ë™û
            - **binder-pokedex-ko.zip** - ÌïúÍµ≠Ïñ¥
            - **binder-pokedex-zh_hans.zip** - ÁÆÄ‰Ωì‰∏≠Êñá
            - **binder-pokedex-zh_hant.zip** - ÁπÅÈ´î‰∏≠Êñá
            
            Each ZIP contains:
            - 81 Generation PDFs (Kanto to Paldea)
            - 36 Variant PDFs (EX Gen1/Gen2/Gen3 + Mega Evolution)
            
            ### ‚ú® New Features in v3.0
            - **EX Variant Series**
              - EX Gen1: 119 Pok√©mon-ex cards
              - EX Gen2: 72 Pok√©mon-EX cards with Mega Evolution
              - EX Gen3: 82 Pok√©mon ex cards with Tera forms
              - Mega Evolution: 76 Pok√©mon with mega forms
            - **Fixed CJK Type Rendering**
              - No more black boxes for Japanese, Korean, Chinese type text!
              - Proper FontManager integration with drawRightString()
            - **Live Progress Bars** for variant PDF generation
            - **Logo Rendering** for EX variants (M Pok√©mon, EX, EX New, EX Tera)
            
            ### üêõ Bug Fixes
            - Fixed CJK type text rendering in card headers
            - Fixed type field compatibility (types array vs type1 field)
            - Improved type text positioning (right-aligned without overflow)
            
            ### üìä Stats
            - **Total PDFs:** 117 (81 generations + 36 variants)
            - **Total Pok√©mon:** 1,025+ including variants
            - **Languages:** 9 (DE, EN, FR, ES, IT, JA, KO, ZH, ZH-T)
            - **Size per PDF:** 5-8 MB with embedded images
            
            ### üîß Technical Details
            - Support for both 'types' array and 'type1' field formats
            - Multilingual variant titles and descriptions
            - Section-based PDF generation with featured Pok√©mon
            - Proper handling of null subtitle values in covers
            
            See commit 7f9d052 for detailed technical changes.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
