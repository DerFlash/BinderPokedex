name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Clean old PDFs from output
        run: |
          echo "Removing old PDFs from output folders..."
          if [ -d output ]; then find output -type f -name '*.pdf' -delete; fi
          echo "Old PDFs removed."
      
      - name: Get tag info
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Release: $TAG_NAME"
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Noto Sans CJK fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-wqy-zenhei fonts-wqy-microhei
          fc-cache -fv

      - name: Generate PDFs
        run: |
          # Generate all scopes
          for scope in Pokedex ExGen1 ExGen2 ExGen3; do
            echo "Generating PDFs for scope: $scope"
            python scripts/pdf/generate_pdf.py --scope $scope
          done
          
          # Verify output directory and PDFs exist
          if [ ! -d output ]; then
            echo "Error: output directory not created"
            exit 1
          fi
          
          PDF_COUNT=$(find output -type f -name '*.pdf' | wc -l)
          echo "Generated $PDF_COUNT PDFs"
          
          if [ "$PDF_COUNT" -eq 0 ]; then
            echo "Error: No PDFs were generated"
            exit 1
          fi
      
      - name: Create PDF artifacts (all languages + individual language zips)
        run: |
          cd output
          
          # Create complete zip with all languages
          zip -r ../binder-pokedex-all-languages.zip . -x ".*" "*/.*"
          
          # Create individual zips per language
          for lang in de en fr es it ja ko zh_hans zh_hant; do
            if [ -d "$lang" ]; then
              zip -r ../binder-pokedex-${lang}.zip $lang -x ".*"
            fi
          done
          
          cd ..
          ls -lh binder-pokedex*.zip
      
      - name: Create Release with Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Binder Pok√©dex ${{ steps.tag.outputs.tag_name }}
          files: |
            binder-pokedex-all-languages.zip
            binder-pokedex-de.zip
            binder-pokedex-en.zip
            binder-pokedex-fr.zip
            binder-pokedex-es.zip
            binder-pokedex-it.zip
            binder-pokedex-ja.zip
            binder-pokedex-ko.zip
            binder-pokedex-zh_hans.zip
            binder-pokedex-zh_hant.zip
          body: |
            ## üöÄ Binder Pok√©dex ${{ steps.tag.outputs.tag_name }} Released!
            
            ‚úÖ **Release complete with all 117 PDFs!**
            
            ### ÔøΩ Bug Fixes
            - **Fixed CJK Font Rendering**: Resolved font warnings and missing CJK characters in GitHub Actions
            - Added Noto Sans CJK font installation and fallback support for Linux environments
            - Japanese, Korean, and Chinese characters now render properly in all PDFs
            
            ### üì¶ Downloads
            - **binder-pokedex-all-languages.zip** - Complete set with all 9 languages (117 PDFs)
            - **binder-pokedex-de.zip** - Deutsch
            - **binder-pokedex-en.zip** - English
            - **binder-pokedex-fr.zip** - Fran√ßais
            - **binder-pokedex-es.zip** - Espa√±ol
            - **binder-pokedex-it.zip** - Italiano
            - **binder-pokedex-ja.zip** - Êó•Êú¨Ë™û
            - **binder-pokedex-ko.zip** - ÌïúÍµ≠Ïñ¥
            - **binder-pokedex-zh_hans.zip** - ÁÆÄ‰Ωì‰∏≠Êñá
            - **binder-pokedex-zh_hant.zip** - ÁπÅÈ´î‰∏≠Êñá
            
            Each ZIP contains:
            - 81 Generation PDFs (Kanto to Paldea)
            - 36 Variant PDFs (EX Gen1/Gen2/Gen3 + Mega Evolution)
            
            ### üìä Stats
            - **Total PDFs:** 117 (81 generations + 36 variants)
            - **Total Pok√©mon:** 1,025+ including variants
            - **Languages:** 9 (DE, EN, FR, ES, IT, JA, KO, ZH, ZH-T)
            - **Size per PDF:** 5-8 MB with embedded images
            
            ### üîß Technical Details
            - Cross-platform font support (macOS Songti + Linux Noto Sans CJK)
            - Automatic font fallback detection
            - Proper CJK character rendering in PDF generation
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
